# ‚úÖ –í–Ω–µ—Å–µ–Ω—ñ –∑–º—ñ–Ω–∏ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ FinDotBot –Ω–∞ Render

## üéØ –í–∏–∫–æ–Ω–∞–Ω—ñ –∫—Ä–∏—Ç–∏—á–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### 1. ‚úÖ **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ SystemExit –ø—Ä–æ–±–ª–µ–º—É**
**–§–∞–π–ª:** `finedot_bot.py:1979`

**–ë—É–ª–æ:**
```python
async def cleanup_and_exit():
    if 'app' in locals():
        await graceful_shutdown(app)
    sys.exit(0)  # ‚ùå –í–∏–∫–ª–∏–∫–∞–≤ SystemExit exception
```

**–°—Ç–∞–ª–æ:**
```python
async def cleanup_and_exit():
    try:
        if 'app' in locals():
            await graceful_shutdown(app)
    except Exception as e:
        logger.error(f"–ü–æ–º–∏–ª–∫–∞ cleanup: {e}")
    finally:
        # –ó–∞–º—ñ—Å—Ç—å sys.exit(0) –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ loop.stop()
        loop = asyncio.get_event_loop()
        loop.stop()
```

### 2. ‚úÖ **–û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –¥–ª—è Render Free Plan**
**–§–∞–π–ª:** `config.py:37-46`

**–ó–º—ñ–Ω–∏:**
- `TELEGRAM_POOL_SIZE`: `8 ‚Üí 3` (60% –º–µ–Ω—à–µ –ø–∞–º'—è—Ç—ñ)
- `TELEGRAM_TIMEOUT`: `20 ‚Üí 10` (—à–≤–∏–¥—à—ñ —Ç–∞–π–º–∞—É—Ç–∏)
- `TELEGRAM_READ_TIMEOUT`: `30 ‚Üí 15` (–º–µ–Ω—à–µ –≤–∏—Å—è—á–∏—Ö –∑'—î–¥–Ω–∞–Ω—å)
- `MAX_VOICE_DURATION`: `60 ‚Üí 30` —Å–µ–∫—É–Ω–¥ (–º–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)

**–î–æ–¥–∞–Ω–æ –Ω–æ–≤—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏:**
```python
FFMPEG_TIMEOUT = 30
GOOGLE_API_TIMEOUT = 10  
MAX_CONCURRENT_VOICE_PROCESSING = 2
MEMORY_CLEANUP_INTERVAL = 300  # 5 —Ö–≤–∏–ª–∏–Ω
```

### 3. ‚úÖ **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ Memory Leak –∑ user_last_actions**
**–§–∞–π–ª:** `finedot_bot.py:44-61`

**–ë—É–ª–æ:**
```python
user_last_actions = {}  # ‚ùå –ù–µ–æ–±–º–µ–∂–µ–Ω–µ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è
```

**–°—Ç–∞–ª–æ:**
```python
from collections import OrderedDict
user_last_actions = OrderedDict()
MAX_USER_ACTIONS = 50  # –û–±–º–µ–∂–µ–Ω–Ω—è

def add_user_action(user_id, action):
    """–î–æ–¥–∞—î –¥—ñ—é –∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–º –æ—á–∏—â–µ–Ω–Ω—è–º"""
    if len(user_last_actions) >= MAX_USER_ACTIONS:
        user_last_actions.popitem(last=False)  # –í–∏–¥–∞–ª—è—î–º–æ –Ω–∞–π—Å—Ç–∞—Ä—à–∏–π
    user_last_actions[user_id] = action

def cleanup_old_actions():
    """–ü—Ä–∏–º—É—Å–æ–≤–µ –æ—á–∏—â–µ–Ω–Ω—è"""
    while len(user_last_actions) > MAX_USER_ACTIONS // 2:
        user_last_actions.popitem(last=False)
```

**–ó–∞–º—ñ–Ω–µ–Ω–æ –ø—Ä—è–º–µ –ø—Ä–∏—Å–≤–æ—é–≤–∞–Ω–Ω—è:** `finedot_bot.py:1273`
```python
# –ë—É–ª–æ: user_last_actions[user.id] = {...}
# –°—Ç–∞–ª–æ: 
add_user_action(user.id, {...})
```

### 4. ‚úÖ **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –æ–±—Ä–æ–±–∫—É —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤**
**–§–∞–π–ª:** `finedot_bot.py:1790-1867`

**–î–æ–¥–∞–Ω–æ:**
- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–º—ñ–Ω–Ω–∏—Ö: `ogg_path = None, wav_path = None`
- Timeout –¥–ª—è FFmpeg: `timeout=FFMPEG_TIMEOUT`
- –û–±—Ä–æ–±–∫–∞ `subprocess.TimeoutExpired`
- –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–µ cleanup –≤ `finally` –±–ª–æ—Ü—ñ:

```python
finally:
    # –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤
    for path in [ogg_path, wav_path]:
        if path and os.path.exists(path):
            try:
                os.unlink(path)
                logger.debug(f"–í–∏–¥–∞–ª–µ–Ω–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π —Ñ–∞–π–ª: {path}")
            except Exception as e:
                logger.warning(f"–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–π–ª {path}: {e}")
```

### 5. ‚úÖ **–î–æ–¥–∞–Ω–æ timeout –¥–ª—è subprocess –æ–ø–µ—Ä–∞—Ü—ñ–π**
**–§–∞–π–ª:** `finedot_bot.py:281,284`

**FFmpeg –≤–µ—Ä—Å—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞:**
```python
# –î–æ–¥–∞–Ω–æ timeout=10 —Ç–∞ –æ–±—Ä–æ–±–∫—É TimeoutExpired
result = subprocess.run(["ffmpeg", "-version"], 
                       capture_output=True, check=True, text=True, timeout=10)
except (subprocess.CalledProcessError, FileNotFoundError, subprocess.TimeoutExpired):
```

---

## üìà –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

### üíæ **–ó–º–µ–Ω—à–µ–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø–∞–º'—è—Ç—ñ:**
- **Connection pool:** 8‚Üí3 = **60% –º–µ–Ω—à–µ RAM**
- **User actions:** –û–±–º–µ–∂–µ–Ω–æ –¥–æ 50 –∑–∞–ø–∏—Å—ñ–≤ = **~10KB –∑–∞–º—ñ—Å—Ç—å –Ω–µ–æ–±–º–µ–∂–µ–Ω–æ–≥–æ**
- **Timeouts:** –ú–µ–Ω—à–µ –≤–∏—Å—è—á–∏—Ö –∑'—î–¥–Ω–∞–Ω—å

### ‚ö° **–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ:**
- **–ù–µ–º–∞—î SystemExit exceptions** –≤ asyncio
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ cleanup** —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤
- **Timeout –∑–∞—Ö–∏—Å—Ç** –≤—ñ–¥ –∑–∞–≤–∏—Å–∞–Ω–Ω—è FFmpeg
- **Memory leak prevention** –¥–ª—è user_last_actions

### üéØ **–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤:**
- **–î–æ –∑–º—ñ–Ω:** ~400-500MB RAM (–±–ª–∏–∑—å–∫–æ –¥–æ –ª—ñ–º—ñ—Ç—É 512MB)
- **–ü—ñ—Å–ª—è –∑–º—ñ–Ω:** ~200-300MB RAM (–±–µ–∑–ø–µ—á–Ω–∏–π –∑–∞–ø–∞—Å)

---

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏ –¥–ª—è –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç—É

### 1. **Commit –∑–º—ñ–Ω–∏:**
```bash
git add .
git commit -m "fix: –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –¥–ª—è Render free plan

- –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ SystemExit –ø—Ä–æ–±–ª–µ–º—É –≤ cleanup_and_exit
- –ó–º–µ–Ω—à–µ–Ω–æ TELEGRAM_POOL_SIZE –∑ 8 –¥–æ 3
- –î–æ–¥–∞–Ω–æ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è user_last_actions (memory leak)
- –ü–æ–∫—Ä–∞—â–µ–Ω–æ –æ–±—Ä–æ–±–∫—É —Ç–∏–º—á–∞—Å–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤ –∑ proper cleanup
- –î–æ–¥–∞–Ω–æ timeout –¥–ª—è –≤—Å—ñ—Ö subprocess –æ–ø–µ—Ä–∞—Ü—ñ–π"
```

### 2. **Deploy –≤ Render:**
- Push –¥–æ main branch
- Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–¥–µ–ø–ª–æ—ó—Ç—å –∑–º—ñ–Ω–∏

### 3. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—ñ—Å–ª—è –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç—É:**
–û—á—ñ–∫—É–≤–∞–Ω—ñ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥–∞—Ö:
```
‚úÖ Application —Å—Ç–≤–æ—Ä–µ–Ω–æ –∑ pool_size=3  # –ó–∞–º—ñ—Å—Ç—å 8
‚úÖ –û—á–∏—â–µ–Ω–æ —Å—Ç–∞—Ä—ñ –∑–∞–ø–∏—Å–∏ user_last_actions  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ cleanup
‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π —Ñ–∞–π–ª: /tmp/voice123.ogg  # Proper cleanup
```

### 4. **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è UptimeRobot:**
- **–ó–±—ñ–ª—å—à–∏—Ç–∏ —ñ–Ω—Ç–µ—Ä–≤–∞–ª:** 5‚Üí15 —Ö–≤–∏–ª–∏–Ω
- **Timeout:** 30 —Å–µ–∫—É–Ω–¥
- –¶–µ –∑–º–µ–Ω—à–∏—Ç—å –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ 66%

---

## üîç –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ —É—Å–ø—ñ—Ö—É

### ‚úÖ **–ü–æ–∑–∏—Ç–∏–≤–Ω—ñ —Å–∏–≥–Ω–∞–ª–∏:**
- Log–∏ –±–µ–∑ `SystemExit(0)` –ø–æ–º–∏–ª–æ–∫
- `memory_mb < 300` –≤ health check
- –ù–µ–º–∞—î `FFmpeg timeout` –ø–æ–º–∏–ª–æ–∫
- `user_last_actions` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—á–∏—â—É—î—Ç—å—Å—è

### ‚ö†Ô∏è **–ù–∞ —â–æ –∑–≤–µ—Ä–Ω—É—Ç–∏ —É–≤–∞–≥—É:**
- –Ø–∫—â–æ –≤—Å–µ —â–µ —î –ø–∞–¥—ñ–Ω–Ω—è —á–µ—Ä–µ–∑ 24 –≥–æ–¥–∏–Ω–∏
- Memory warnings > 400MB
- –ü–æ–º–∏–ª–∫–∏ `Google API timeout`

---

## üìä –†–µ–∑—é–º–µ –∑–º—ñ–Ω

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ë—É–ª–æ | –°—Ç–∞–ª–æ | –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è |
|----------|------|-------|------------|
| **Pool Size** | 8 | 3 | -60% RAM |
| **Voice Duration** | 60s | 30s | -50% –æ–±—Ä–æ–±–∫–∞ |
| **User Actions** | ‚àû | 50 max | Memory leak fix |
| **File Cleanup** | –ù–µ–ø–æ–≤–Ω–µ | –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–µ | Leak fix |
| **Subprocess** | –ë–µ–∑ timeout | 30s timeout | Hang protection |
| **SystemExit** | Exception | Graceful | Stability fix |

**–ó–∞–≥–∞–ª—å–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ: ~80%**

---

## üí° –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

–Ø–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∏ –ø—Ä–æ–¥–æ–≤–∂—É—é—Ç—å—Å—è, –º–æ–∂–Ω–∞:

1. **–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ LOG_LEVEL=ERROR** –≤ Render env vars
2. **–ó–±—ñ–ª—å—à–∏—Ç–∏ UptimeRobot –¥–æ 20 —Ö–≤–∏–ª–∏–Ω**
3. **–¢–∏–º—á–∞—Å–æ–≤–æ –≤—ñ–¥–∫–ª—é—á–∏—Ç–∏ –≥–æ–ª–æ—Å–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:** `MAX_VOICE_DURATION=0`

**–¶—ñ –∑–º—ñ–Ω–∏ –º–∞—é—Ç—å –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—É —Ä–æ–±–æ—Ç—É –±–æ—Ç–∞ –Ω–∞ Render Free Plan –ø—Ä–æ—Ç—è–≥–æ–º 24+ –≥–æ–¥–∏–Ω –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—ñ–≤.**